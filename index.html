<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Assistant</title>

    <!-- Material Symbols -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Enhanced Fonts: Inter, Tangerine (calligraphic), JetBrains Mono, Doto, Major Mono Display -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Tangerine:wght@400;700&family=JetBrains+Mono:wght@400;500;700&family=Doto:wght@100..900&family=Major+Mono+Display&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link rel="stylesheet" href="css/style.css?v=7">
    <link rel="stylesheet" href="css/ui-fixes.css">
    <link rel="stylesheet" href="css/mobile-optimizations.css">
    <link rel="stylesheet" href="css/warning-style.css">
    <link rel="stylesheet" href="css/auth-style.css">
</head>

<body>
    <!-- Particle Background Canvas -->
    <canvas id="particle-canvas"></canvas>

    <!-- Cursor Follower (PC) -->
    <div id="cursor-follower"></div>

    <!-- Brand Logo -->
    <div class="brand-logo">ccooffee</div>

    <!-- User Profile / Login -->
    <div id="user-profile" class="user-profile hidden">
        <div class="user-avatar">
            <span id="user-avatar-text">U</span>
        </div>
        <div id="profile-dropdown" class="profile-dropdown hidden">
            <div class="profile-info">
                <div class="profile-name" id="user-display-name">User</div>
                <div class="profile-email" id="user-email">user@example.com</div>
            </div>
            <div class="profile-divider"></div>
            <button class="profile-menu-item" id="level-btn">
                <span class="material-symbols-rounded">military_tech</span>
                Level
            </button>
            <button class="profile-menu-item" id="stats-btn">
                <span class="material-symbols-rounded">bar_chart</span>
                Stats
            </button>
            <button class="profile-menu-item" id="favorites-btn">
                <span class="material-symbols-rounded">favorite</span>
                Favoriten
            </button>
            <button class="profile-menu-item" id="leaderboard-btn">
                <span class="material-symbols-rounded">leaderboard</span>
                Leaderboard
            </button>
            <div class="profile-divider"></div>
            <button class="profile-menu-item" id="logout-btn">
                <span class="material-symbols-rounded">logout</span>
                Abmelden
            </button>
        </div>
    </div>
    <button id="login-btn" class="login-btn">
        <span class="material-symbols-rounded">login</span>
        Anmelden
    </button>

    <!-- Navigation (Top, Fixed, Always Visible) -->
    <nav id="main-nav" class="glass-nav">
        <button class="nav-btn" onclick="router.navigate('home')"><span
                class="material-symbols-rounded">home</span></button>
        <button class="nav-btn" onclick="router.navigate('brew')"><span
                class="material-symbols-rounded">coffee_maker</span></button>
        <button class="nav-btn" onclick="router.navigate('drinks')"><span
                class="material-symbols-rounded">menu_book</span></button>
        <button class="nav-btn" onclick="router.navigate('shops')"><span
                class="material-symbols-rounded">storefront</span></button>
        <button class="nav-btn" onclick="router.navigate('dialin')"><span
                class="material-symbols-rounded">tune</span></button>
        <button class="nav-btn" onclick="router.navigate('knowledge')"><span
                class="material-symbols-rounded">school</span></button>
    </nav>

    <!-- ROOTS -->
    <main id="app">

        <!-- HOME PAGE -->
        <section id="home" class="page active">
            <!-- Guest Mode Warning -->
            <div id="guest-warning" class="guest-warning glass-panel hidden">
                <span class="material-symbols-rounded">info</span>
                <p><strong>Gast-Modus:</strong> Deine Einträge werden nur temporär auf diesem Gerät gespeichert. Melde
                    dich an, um sie sicher zu synchronisieren.</p>
            </div>

            <!-- Dashboard / Tile Navigation -->
            <div class="content-section">
                <!-- Removed inner glass-panel to allow full bleed gradient blend -->

                <div class="tile-grid">
                    <div class="tile tile-large"
                        onclick="document.getElementById('about-modal').classList.add('visible')">
                        <span class="material-symbols-rounded icon">person</span>
                        <h2>Über mich</h2>
                        <p>Das Gesicht hinter ccooffee</p>
                    </div>
                    <div class="tile" onclick="router.navigate('brew')">
                        <span class="material-symbols-rounded icon">coffee_maker</span>
                        <h2>Brew Tracker</h2>
                        <p>Track your shots</p>
                    </div>
                    <div class="tile" onclick="router.navigate('drinks')">
                        <span class="material-symbols-rounded icon">local_cafe</span>
                        <h2>Recipes</h2>
                        <p>Manage drinks</p>
                    </div>
                    <div class="tile" onclick="router.navigate('dialin')">
                        <span class="material-symbols-rounded icon">tune</span>
                        <h2>Dial-In</h2>
                        <p>Calculate your shot</p>
                    </div>
                    <!-- Knowledge Base Entry -->
                    <div class="tile" onclick="router.navigate('knowledge')">
                        <span class="material-symbols-rounded icon">school</span>
                        <h2>Wissen</h2>
                        <p>Explore coffee knowledge</p>
                    </div>
                    <div class="tile" onclick="router.navigate('shops')">
                        <span class="material-symbols-rounded icon">map</span>
                        <h2>ccooffee shops</h2>
                        <p>Explore spots</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- BREW PAGE -->
        <section id="brew" class="page">
            <header class="page-header">
                <h1>BREWS</h1>
                <button class="fab" onclick="brewManager.openSkillModal()"><span
                        class="material-symbols-rounded">add</span></button>
            </header>

            <!-- Guest Mode Warning -->
            <div class="guest-warning glass-panel hidden">
                <span class="material-symbols-rounded">info</span>
                <p><strong>Gast-Modus:</strong> Deine Einträge werden nur temporär gespeichert.</p>
            </div>
            <div id="brew-list" class="brew-list-container">
                <!-- Pills will be injected here -->
            </div>
        </section>

        <!-- DRINKS PAGE -->
        <section id="drinks" class="page">
            <header class="page-header">
                <h1>RECIPES</h1>
                <button class="fab" onclick="drinkManager.openAddModal()"><span
                        class="material-symbols-rounded">add</span></button>
            </header>

            <!-- Guest Mode Warning -->
            <div class="guest-warning glass-panel hidden">
                <span class="material-symbols-rounded">info</span>
                <p><strong>Gast-Modus:</strong> Deine Einträge werden nur temporär gespeichert.</p>
            </div>
            <div id="drink-list" class="grid-list-container">
                <!-- Pills will be injected here -->
            </div>
        </section>

        <!-- DIAL-IN PAGE -->
        <section id="dialin" class="page epic-page">
            <div class="epic-background"></div>
            <header class="page-header epic-header">
                <h1>dial-in</h1>
            </header>

            <div class="dial-in-container glass-panel-dark">
                <div class="input-group">
                    <label>Target Time (s)</label>
                    <input type="number" id="target-time" placeholder="25" step="1">
                </div>

                <div class="shot-inputs">
                    <div class="shot-card">
                        <h3>Test Shot 1</h3>
                        <input type="number" id="g1" placeholder="Grind Setting (e.g. 10)" step="0.1">
                        <input type="number" id="t1" placeholder="Time (s)" step="1">
                    </div>
                    <div class="shot-card">
                        <h3>Test Shot 2</h3>
                        <input type="number" id="g2" placeholder="Grind Setting (e.g. 12)" step="0.1">
                        <input type="number" id="t2" placeholder="Time (s)" step="1">
                    </div>
                </div>

                <button class="calculate-btn" onclick="dialIn.calculate()">CALCULATE</button>

                <div id="dial-result" class="result-box hidden">
                    <span class="label">Recommended Grind</span>
                    <span class="value" id="result-grind">--</span>
                    <p class="warning-text">Note: Due to non-linear particle distribution, consider adjusting 0.2 - 0.5
                        steps coarser.</p>
                </div>
            </div>
        </section>


        <!-- SHOPS PAGE -->
        <section id="shops" class="page">
            <header class="page-header">
                <h1>CCOOFFEE SHOP</h1>
                <button class="fab" onclick="shopManager.openAddModal()"><span
                        class="material-symbols-rounded">add</span></button>
            </header>

            <!-- Guest Mode Warning -->
            <div class="guest-warning glass-panel hidden">
                <span class="material-symbols-rounded">info</span>
                <p><strong>Gast-Modus:</strong> Deine Einträge werden nur temporär gespeichert.</p>
            </div>

            <div class="map-toggle-container">
                <button id="view-list" class="toggle-btn active" onclick="shopManager.switchView('list')">List</button>
                <button id="view-map" class="toggle-btn" onclick="shopManager.switchView('map')">Map</button>
            </div>

            <div id="shop-list" class="shop-list-container">
                <!-- Shop Pills -->
            </div>
            <div id="shop-map-container" class="map-container hidden"></div>
        </section>

        <!-- KNOWLEDGE BASE -->
        <section id="knowledge" class="page">
            <div class="header">
                <h1>Expert Knowledge</h1>
                <p>The Ultimate Barista Knowledge Base</p>
            </div>
            <div class="knowledge-grid" id="knowledge-grid">
                <!-- Topics rendered via JS -->
            </div>

            <!-- Knowledge Detail Modal -->
            <div id="knowledge-modal" class="modal hidden">
                <div class="modal-content knowledge-modal-content glass-panel">
                    <span class="close" id="knowledge-modal-close">&times;</span>
                    <div class="knowledge-detail-header">
                        <span class="material-symbols-rounded" id="k-detail-icon">school</span>
                        <h2 id="k-detail-title">Topic Title</h2>
                    </div>
                    <div class="knowledge-detail-body" id="k-detail-body">
                        <!-- Content -->
                    </div>
                </div>
            </div>

            <!-- Trouble Detail Modal (Mobile) -->
            <div id="trouble-detail-modal" class="modal hidden">
                <div class="modal-content trouble-modal-content glass-panel">
                    <span class="close"
                        onclick="document.getElementById('trouble-detail-modal').classList.remove('visible'); setTimeout(() => document.getElementById('trouble-detail-modal').classList.add('hidden'), 300);">&times;</span>
                    <div class="knowledge-detail-header">
                        <span class="material-symbols-rounded"
                            style="color:var(--color-gold-bright); font-size:32px;">build</span>
                        <h2 id="td-title"
                            style="margin:0; font-family:var(--font-display); font-size:1.8rem; background: linear-gradient(90deg, #fff, var(--color-gold-light)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            Symptom</h2>
                    </div>
                    <div class="knowledge-detail-body" style="padding: 30px;">
                        <h3
                            style="color:var(--color-gold-medium); font-family:var(--font-heading); margin-bottom:10px;">
                            Ursache</h3>
                        <p id="td-cause"
                            style="font-family:var(--font-body); color:var(--color-cream); margin-bottom: 24px; line-height:1.6; font-size:1.1rem;">
                        </p>

                        <h3
                            style="color:var(--md-sys-color-primary); font-family:var(--font-heading); margin-bottom:10px;">
                            Lösung</h3>
                        <p id="td-solution"
                            style="font-family:var(--font-body); color:var(--color-cream); line-height:1.6; font-size:1.1rem;">
                        </p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- MODALS -->
    <!-- About Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content glass-panel" style="text-align: center; padding: 40px 20px;">
            <span class="close"
                onclick="document.getElementById('about-modal').classList.remove('visible')">&times;</span>
            <div style="margin-bottom: 20px;">
                <span class="material-symbols-rounded"
                    style="font-size: 64px; color: var(--color-gold-bright);">person</span>
            </div>
            <h2>Hey, ich bin noxram!</h2>
            <br>
            <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 30px;">
                Willkommen bei <strong>ccooffee</strong> – deinem ultimativen Barista-Begleiter. Ich habe dieses Projekt
                ins Leben gerufen, um Baristas und Specialty Coffee Fans ein Tool zur Hand zu geben, um ihre Skills zu
                perfektionieren.
                <br><br>
                Wenn du mehr über meine Arbeit und meine Projekte erfahren willst, schau gerne auf meinem YouTube-Kanal
                vorbei!
            </p>
            <a href="https://www.youtube.com/@its_noxram" target="_blank"
                style="display: inline-block; background: var(--color-gold-bright); color: #000; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; font-family: var(--font-display); letter-spacing: 1px;">Zum
                YouTube Kanal</a>
        </div>
    </div>
    <!-- Brew Skill Level Modal -->
    <div id="brew-skill-modal" class="modal">
        <div class="modal-content glass-panel" style="text-align: center;">
            <span class="close"
                onclick="document.getElementById('brew-skill-modal').classList.remove('visible'); setTimeout(() => document.getElementById('brew-skill-modal').classList.add('hidden'), 300);">&times;</span>
            <h2 style="margin-bottom: 24px;">Select Skill Level</h2>
            <div class="skill-level-container">
                <button class="skill-btn" onclick="brewManager.selectSkillLevel('easy')">
                    <span class="material-symbols-rounded">sentiment_satisfied</span>
                    <span class="skill-text">Easy</span>
                </button>
                <button class="skill-btn" onclick="brewManager.selectSkillLevel('medium')">
                    <span class="material-symbols-rounded">psychology</span>
                    <span class="skill-text">Medium</span>
                </button>
                <button class="skill-btn" onclick="brewManager.selectSkillLevel('expert')">
                    <span class="material-symbols-rounded">science</span>
                    <span class="skill-text">Expert</span>
                </button>
            </div>
            <p style="margin-top: 20px; font-size: 0.9rem; color: var(--color-gold-dark);">Wähle das Level passend zu
                deiner Erfahrung und deinen Messwerkzeugen.</p>
        </div>
    </div>

    <!-- Brew Modal -->
    <div id="brew-modal" class="modal">
        <div class="modal-content glass-panel">
            <span class="close" onclick="brewManager.closeModal()">&times;</span>
            <h2>New Espresso</h2>
            <!-- form classes: form-easy | form-medium | form-expert -->
            <form id="brew-form">
                <input type="hidden" name="skillLevel" id="skillLevel" value="easy">

                <input type="text" name="beanName" placeholder="Bean Name" required>
                <!-- All levels -->
                <input type="text" name="roastDate" placeholder="Roast Date" onfocus="(this.type='date')"
                    onblur="if(!this.value)this.type='text'">

                <!-- Expert -->
                <input type="text" name="grinder" class="lvl-expert" placeholder="Grinder">

                <!-- All levels -->
                <input type="number" name="grindSize" placeholder="Grind Size" step="0.1">

                <!-- Expert -->
                <input type="number" name="rpm" class="lvl-expert" placeholder="RPM" step="10">
                <input type="number" name="temp" class="lvl-expert" placeholder="Temperature (°C)" step="0.1">

                <div class="row">
                    <!-- All levels -->
                    <input type="number" name="doseIn" id="doseIn" placeholder="Dose In (g)" step="0.1" required>
                    <input type="number" name="doseOut" id="doseOut" placeholder="Dose Out (g)" step="0.1" required>
                </div>
                <!-- All levels -->
                <input type="number" name="targetTime" placeholder="Target Time (s)" step="1">
                <div class="suggestion" style="margin-bottom: 20px;">Yield Ratio: <span id="target-ratio">1:--</span>
                </div>

                <!-- Expert Only Section -->
                <div class="lvl-expert expert-mechanics">
                    <p style="font-size: 0.8rem; color: var(--color-gold-dark); margin-bottom: 12px;">i: wenn keine
                        preinfusion oder tapering gemacht wird einfach felder leer lassen</p>

                    <div class="profile-row">
                        <label>Preinfusion</label>
                        <div class="profile-inputs">
                            <input type="number" name="piBar" placeholder="bar" step="0.1" min="0" max="12">
                            <span>@</span>
                            <input type="number" name="piTime" placeholder="time (s)" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="profile-row">
                        <label>Peak</label>
                        <div class="profile-inputs">
                            <input type="number" name="peakBar" placeholder="bar" step="0.1" min="0" max="15">
                            <span>@</span>
                            <input type="number" name="peakTime" placeholder="time (s)" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="profile-row">
                        <label>Tapering</label>
                        <div class="profile-inputs">
                            <input type="number" name="tapBar" placeholder="bar" step="0.1" min="0" max="15">
                            <span>@</span>
                            <input type="number" name="tapTime" placeholder="time (s)" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="file-upload">
                        <label for="curve-upload" class="upload-btn">
                            <span class="material-symbols-rounded">upload</span> Extraction Curve (PNG)
                        </label>
                        <input type="file" id="curve-upload" accept="image/png">
                    </div>
                </div>

                <button type="submit" class="save-btn">Save Brew</button>
            </form>
        </div>
    </div>

    <!-- Drink Modal -->
    <div id="drink-modal" class="modal">
        <div class="modal-content glass-panel">
            <span class="close" onclick="drinkManager.closeModal()">&times;</span>
            <h2>New Recipe</h2>
            <form id="drink-form">
                <input type="text" name="drinkName" placeholder="Drink Name" required>
                <div style="position: relative;">
                    <textarea name="recipe" id="recipe-textarea" placeholder="Recipe Instructions (@ for brews)..."
                        rows="5"></textarea>
                    <div id="mention-dropdown" class="mention-dropdown hidden glass-panel"></div>
                </div>
                <!-- Image input handled technically differently or simplify for now -->
                <button type="submit" class="save-btn">Save Recipe</button>
            </form>
        </div>
    </div>

    <!-- Shop Modal -->
    <div id="shop-modal" class="modal">
        <div class="modal-content glass-panel">
            <span class="close" onclick="shopManager.closeModal()">&times;</span>
            <h2>New Spot</h2>
            <form id="shop-form">
                <input type="text" name="shopName" placeholder="Shop Name" required>
                <div class="row">
                    <input type="text" name="location" id="shop-location" placeholder="City / Search">
                    <button type="button" class="icon-btn" onclick="shopManager.getCurrentLocation()"><span
                            class="material-symbols-rounded">my_location</span></button>
                </div>
                <textarea name="notes" placeholder="Notes..."></textarea>
                <div class="rating-input">
                    <label>Rating (1-5)</label>
                    <input type="range" name="rating" min="1" max="5" value="5"
                        oninput="document.getElementById('rating-val').innerText = this.value">
                    <span id="rating-val">5</span>
                </div>
                <button type="submit" class="save-btn">Save Spot</button>
            </form>
        </div>
    </div>

    <!-- Auth Modal (Login/Signup) -->
    <div id="auth-modal" class="modal hidden">
        <div class="modal-content glass-panel">
            <span class="close">&times;</span>
            <h2 id="auth-title">Anmelden</h2>
            <form id="auth-form" data-mode="login">
                <div id="display-name-field" class="hidden">
                    <input type="text" name="display-name" placeholder="Anzeigename">
                </div>
                <input type="email" name="email" placeholder="E-Mail" required>
                <input type="password" name="password" placeholder="Passwort" required minlength="6">
                <div id="auth-error" class="auth-error"></div>
                <button type="submit" id="auth-submit" class="save-btn">Anmelden</button>

                <div class="auth-divider">
                    <span>ODER</span>
                </div>

                <button type="button" id="google-auth-btn" class="google-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google Logo">
                    <span>Mit Google anmelden</span>
                </button>
                <div class="auth-switch">
                    <span id="auth-switch-text">Noch kein Konto?</span>
                    <button type="button" id="auth-switch-btn" class="link-btn">Registrieren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="modal hidden">
        <div class="modal-content leaderboard-modal-content glass-panel">
            <span class="close" id="leaderboard-modal-close">&times;</span>
            <div class="level-header">
                <span class="material-symbols-rounded level-icon">leaderboard</span>
                <h2>Leaderboard</h2>
            </div>
            <div id="leaderboard-list" class="leaderboard-list">
                <p class="lb-loading">Lade Rangliste…</p>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal" class="modal hidden">
        <div class="modal-content stats-modal-content glass-panel">
            <span class="close" id="stats-modal-close">&times;</span>
            <div class="level-header">
                <span class="material-symbols-rounded level-icon">bar_chart</span>
                <h2>Deine Stats</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="material-symbols-rounded stat-icon">coffee</span>
                    <span class="stat-value" id="stats-brews">0</span>
                    <span class="stat-label">Brews</span>
                </div>
                <div class="stat-card">
                    <span class="material-symbols-rounded stat-icon">menu_book</span>
                    <span class="stat-value" id="stats-recipes">0</span>
                    <span class="stat-label">Recipes</span>
                </div>
                <div class="stat-card">
                    <span class="material-symbols-rounded stat-icon">storefront</span>
                    <span class="stat-value" id="stats-shops">0</span>
                    <span class="stat-label">Shops</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favorites-modal" class="modal hidden">
        <div class="modal-content favorites-modal-content glass-panel">
            <span class="close" id="favorites-modal-close">&times;</span>
            <div class="level-header">
                <span class="material-symbols-rounded level-icon"
                    style="color: #e74c3c; -webkit-text-fill-color: #e74c3c;">favorite</span>
                <h2
                    style="background: linear-gradient(135deg, #e74c3c, #ff8c69); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip:text;">
                    Favoriten</h2>
            </div>
            <div id="favorites-brew-list" class="favorites-brew-list"></div>
        </div>
    </div>

    <!-- Level Modal -->
    <div id="level-modal" class="modal hidden">
        <div class="modal-content level-modal-content glass-panel">
            <span class="close" id="level-modal-close">&times;</span>
            <div class="level-header">
                <span class="material-symbols-rounded level-icon">military_tech</span>
                <h2 id="level-title">Trainee Barista</h2>
            </div>
            <div class="level-points-display">
                <span class="level-points-label">ccooffee points</span>
                <span class="level-points-value" id="level-points-value">0</span>
            </div>
            <div class="level-progress-section">
                <div class="level-progress-bar-bg">
                    <div class="level-progress-bar-fill" id="level-progress-fill"></div>
                </div>
                <p class="level-next-info" id="level-next-info">Noch 10 Punkte bis zum nächsten Level</p>
            </div>
        </div>
    </div>

    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/auth.js?v=9"></script>
    <script src="js/particle-bg.js"></script>
    <script src="js/app.js?v=9"></script>
</body>

</html>